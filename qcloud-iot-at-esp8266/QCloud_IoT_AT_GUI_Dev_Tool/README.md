# IoTDevTool 腾讯云IoT AT模组工具使用说明

## 工具简介
本工具用于在Windows环境（Win7/10）体验和测试ESP8266模组腾讯云IoT AT定制固件，也可以作为普通的AT模组串口调试工具。工具和模组的交互基于《腾讯云IoT AT指令集-WiFi-ESP8266》，实现了对设备信息设置、连接WiFi、SmartConfig配网、softAP配网、连接腾讯云MQTT服务、订阅主题、取消订阅、发布消息、发布长消息等功能指令的GUI封装，方便用户使用。同时也提供了原始AT指令模式进行使用。
在本文档中，**设备**是指在腾讯云物联平台创建的设备，**模组**是指ESP8266这个通过串口连接PC的通讯模组。

## 程序界面
程序启动的界面如图所示:
![](https://main.qcloudimg.com/raw/f42b490318d27a661d75970faca963cf.png)
程序主要分为3个区域：串口列表区域（数字[1、2、3]）、指令编辑和历史记录区域（主体区域，数字[4、5、6、7]）、扩展区域（将配网、腾讯云等相关功能封装成GUI的区域，数字[9、10、11]）。
另外，鼠标移动到数字[8]所在位置可以弹出一个按钮，点击该按钮可以展开或者关闭扩展区域。

## 快速体验
在Windows环境下载并解开压缩包，打开IoTDevTool.exe，PC连接ESP8266串口模组，就可按照下面步骤快速体验访问腾讯云物联网服务。
![](https://main.qcloudimg.com/raw/cec5a83a98beb437d7b5b6170667b2c0.png)

1. 扫描并连接串口
2. 配置腾讯云物联网创建的设备信息
3. 将设备信息设置到模组上
4. 直接连接WiFi（如果是物联网开发平台创建的设备，也可以通过配网方式进行连接）
5. 连接腾讯云MQTT服务
6. 订阅相关MQTT主题（需要根据物联网通信或物联网开发平台的协议进行主题设置）
7. 编写消息内容并发布消息
8. 可以在消息窗口看到AT指令交互的过程，成功收到下行消息时，可以看到模组通过URC上报消息

## 详细使用说明
### 连接串口
点击**扫描串口**按钮可以扫描当前已经连接到电脑且可以被识别的串口设备。程序启动时，会自动进行一次扫描模组操作。在程序启动后，除非当前已经打开的模组被强行拔除，否则不会再自动触发扫描模组的操作，想要调试新接入的模组，请再次点击**扫描串口**按钮。界面图中，数字[2]的位置是串口列表，单击可以选择串口设备，双击可以选择设置串口属性，如“波特率”等。点击“OK”或者直接关闭窗口都会保存串口配置信息，这些信息会被保存到和串口名相关的配置文件中。

当没有串口设备被选中时，**Connect**按钮处于禁用状态，选择模组后，该按钮会恢复，点击该按钮，程序将连接到模组，同时**Connect**将变为**Disconnect**，点击可以断开程序与模组的连接。

### AT指令模式
成功连接串口模组后，程序将处于“AT指令模式”，可以看到数字[11]所在区域的**AT指令模式**按钮为选中状态。在此模式下，你可以在指令输入栏（数字[6]所在区域）编写符合《腾讯云IoT AT指令集-WiFi-ESP8266》或者其他原始AT指令。按下Enter键或者点击发送按钮，指令将被发送至模组。

### 连接WiFi
程序在连接ESP8266模组后，会自动发送AT指令来查询模组的WiFi连接状态和腾讯云连接状态。
根据模组此刻的网络状态，数字[11]所在区域第二行的按钮可能有以下几种文本：断开WiFi、直接连接WiFi、SmartConfig配网、softAP配网、停止SmartConfig配网、停止softAP配网。
当WiFi处于连接状态时，按钮的文本为**断开WiFi**，点击该按钮任何位置都将向模组发送`AT+CWQAP`指令以断开WiFi连接。
当模组未连接WiFi时，按钮的文本为：**直接连接WiFi**、**SmartConfig配网**、**softAP配网**等三个文本中的一个。点击按钮右边的“∨”符号将展开下拉框，可以从下拉框中选择一种连接WiFi的方式。注意：“∨”符号的区域大小为按钮最右侧的正方形大小。

#### 1. 直接连接WiFi
点击**直接连接WiFi**后，程序将弹出一个窗口，用户可以设置目标WiFi的SSID/PASSWORD，默认情况下，“OK”按钮将被禁用，直到“SSID”输入栏中有最少一个字符并且“PASSWORD”输入栏中最少有8个字符。
点击“Cancel”按钮或者直接关闭弹窗将会回到主窗口，点击“OK”按钮将会关闭设置窗口，并在在窗口关闭后，先后向模组发送两条指令：`AT+CWMODE=1`，`AT+CWJAP="ssid","pwd"`，其中ssid和pwd分别是刚才窗口中设置的值。保存的SSID和PASSWORD在下次直接连接WiFi弹窗时会自动加载。
当消息窗口出现下面打印，就表明连接WiFi成功。
```
WIFI CONNECTED
WIFI GOT IP
```
`AT+CWJAP`的指令发送后，**直接连接WiFi**按钮将被禁用，直到WiFi连接成功或者WiFi连接失败，按钮才会恢复。

#### 2. SmartConfig配网
点击**SmartConfig配网**按钮后，程序将向模组发送`AT+TCSTARTSMART`指令，使模组将进入SmartConfig配网状态，同时历史记录区将显示一个二维码，用微信或者腾讯连连小程序扫描该二维码，即可使用手机为模组配网并添加设备。根据小程序的提示选择WiFi并输入密码即可让模组连接该WiFi，并按照协议完成设备绑定操作。当消息窗口出现下面打印，就表明配网成功。
```
+TCSTARTSMART:WIFI_CONNECT_SUCCESS
```
另外，点击该按钮，模组进入SmartConfig配网状态后，按钮的文本将变为**停止SmartConfig配网**，点击按钮的任何区域，程序都将向模组发送`AT+TCSTOPSMART`指令以停止SmartConfig配网。

#### 3. softAP方式配网
点击**softAP配网**按钮后，程序将弹出一个窗口：
![](https://main.qcloudimg.com/raw/2127e37421f2184b759c0b6314136b17.png)

在这个窗口需要设置好ESP8266模组热点的“SSID”和“Password”，并使用微信或者腾讯连连小程序扫描弹窗中的二维码。然后点击“OK”关闭窗口。
此时程序会向模组发送`AT+TCSAP="ssid","pwd"`指令，其中ssid和pwd是刚才弹窗中配置的SSID和Password，此指令会让模组进入softAP配网状态。使用微信或者腾讯连连小程序扫描弹窗中的二维码后，会进入配网页面，按照小程序的指引即可为模组进行softAP配网和设备绑定。当消息窗口出现下面打印，就表明配网成功。
```
+TCSAP:WIFI_CONNECT_SUCCESS
```
点击该按钮，模组进入softAP配网状态后，按钮的文本将变为**停止softAP配网**，点击按钮的任何区域，程序都将向模组发送`AT+TCSTOPSAP`指令以停止softAP配网。


### 连接腾讯云物联网
当用户连接上WiFi之后，**连接腾讯云**按钮会变成可用状态，此时点击该按钮，程序都将向模组发送`AT+TCMQTTCONN`指令，使模组通过MQTT连接腾讯云物联网服务。
连接腾讯云之前，用户需要在该工具右上角设置相关的信息：物联网设备信息和MQTT连接参数。
- 物联网设备信息：
物联网设备的三元组信息：ProductID、DeviceName、DeviceSecret，用户首先需要在腾讯云物联网通信或者物联网开发平台的控制台创建设备，并获取相关设备信息。设置好设备信息后，点击**设置设备信息**即可通过`AT+TCDEVINFOSET`将信息写入到模组。
目前ESP8266模组仅支持“TLS密钥认证”，不支持证书设备连接。在程序正常关闭时，这些设置会被保存到和模组名相关的配置文件中，下次使用该模组时，将会自动加载。

- MQTT连接参数：
程序启动时，会默认设置MQTT连接参数，用户也可以根据自己的需要进行配置。

成功连接到腾讯云之后，**连接腾讯云**按钮会变为**断开腾讯云**，再次点击它，程序都将向模组发送`AT+TCMQTTDISCONN`指令，模组将会断开MQTT连接。
当模组连接腾讯云之后，“设备参数”和“MQTT连接参数”两个区域都将被禁用，同时**设置设备信息**的按钮也会被禁用，直到模组断开与腾讯云的连接。

### 物联网服务
程序与模组交互模式一共有5种，一般情况下仅能使用“AT指令模式”。剩下的四种模式是用于与物联网服务进行交互，需要连接腾讯云之后才能操作。
连接到腾讯云之后，订阅主题、取消订阅、发布消息、发布长消息等四个按钮都会由禁用状态变为可用状态：
![](https://main.qcloudimg.com/raw/2d33975e189f799820ca9abdd02cdf06.png)

这四个模式加上AT指令模式是互斥的关系，同一时间只能有一个按钮处于被选中状态，不同按钮按下之后，输入窗口区域会发生相应的变化。

**订阅主题**和**取消订阅**这两种模式会禁用指令输入栏，同时弹出一个topic编辑栏，在该编辑栏中编辑好主题名称，然后点击命令编辑栏右下角的按钮即可订阅或者取消订阅主题。

**发布消息**和**发布长消息**模式会启用指令编辑栏，在指令编辑栏中不需要编辑指令，只需编写消息体即可。消息体可以换行，使用“Alt+Enter”即可输入换行符（直接按Enter键将会发送消息，和点击编辑框右下角的按钮效果是一样的），程序在向模组发送指令时，会自动将换行符替换成空格。另外，程序会自动为**双引号和逗号**添加转义字符，用户不需要自己添加转义字符。

这时用户可按照腾讯云物联网服务的相关数据协议进行上下行通信，如下图是依据[数据模板协议](https://cloud.tencent.com/document/product/1081/34916)与物联网开发平台进行消息交互
![](https://main.qcloudimg.com/raw/7f8f02ac03d638bff9a5e6c832f2f11d.png)

在物联网开发平台控制台就可以看到相关消息
![](https://main.qcloudimg.com/raw/8bdce35c834ca82dab979496431871df.png)

如果通过腾讯连连小程序完成了添加设备操作，则也可以直接通过小程序与设备模组进行交互。


### V1.1 更新：
1. 添加“扫描WiFi”的方式连接WiFi，在弹窗中选择ssid，并填充password的形式。
2. 修复发布长消息时的分割线没有换行的bug
3. Ctrl + 左键双击历史记录区，textBrowser字体恢复原始大小。
4. 利用状态栏显示模组状态信息（网络状态，腾讯云连接状态等）
5. “\r\n”做成可选状态
6. 按住Ctrl键双击可以清空指令编辑栏
7. 指令编辑区和topic编辑栏增加历史记录功能（Ctrl+↑、↓）
